//TODO
// Get data into json and then list
// Sort warranty
// print warranties
// check for added warranties daily and append to bottom of the list
// Overwrite warranties weekly incase extended warranty is purchased.


// The two variables contain our keys to get access to Dell Warranty and therefore in github will be let as blank. This key was simply purhcased from Dell
var clientId = "";
var clientSecret = ""; 


// Function checks the entire sheets current warranties and also devices and stores them to compare what is missing
  function fullSheetCheck()
  {
    dwws.getRange(8, 8).setValue("Running");

    var allDevices = [];
    var dellWarrDevices = [];
    var serviceTag;

  // For loop to get the Dell Servicetags for "All Devices" and also for "Dell Warr API" sheet to compare if any new ones have been added
  // Make sure simplier
    for(var y = 2; y < dwws.getLastRow()+1; y++)
    {
      serviceTag = dwws.getRange(y,helperColumn).getValue();
      allDevices.push(serviceTag);

      if(dwws.getRange(y,1).getValue() != "") // This was still grabbing empty cells if I had text in F column maybe??
      {
        serviceTag = dwws.getRange(y,1).getValue();
        dellWarrDevices.push(serviceTag);
      }
    }
    
   // If a Servicetag from "All Devices" sheet is not in "Dell Warr API" Sheet. Add it to the bottom
    for(var y = 0; y < allDevices.length; y++)
    {
      if(!dellWarrDevices.includes(allDevices[y]))
      {
        dellWarrDevices.push(allDevices[y]);
        dwws.getRange((dellWarrDevices.length + 1),1).setValue(allDevices[y]); // Can remove this line
        updateDeviceRowInformation(dellWarrDevices.length + 1);
      }
    }

    dwws.getRange(8, 8).setValue("Finished!");
  }
  
  
  // Get device information for a single row
function updateDeviceRowInformation(rowIndex)
{
  if(dwws.getRange(rowIndex,2).getValue() == "")
  {
    var serviceTag = dwws.getRange(rowIndex,1).getValue().toString();
    var deviceInformation = getDellWarranty(serviceTag);
    
    // figure out how to oneline this in javascript
    dwws.getRange(rowIndex, 2).setValue(deviceInformation[0]),
    dwws.getRange(rowIndex, 3).setValue(deviceInformation[1]),
    dwws.getRange(rowIndex, 4).setValue(deviceInformation[2]),
    dwws.getRange(rowIndex, 5).setValue(deviceInformation[3]);
  }
}


// This uses 0Auth, an authentication method which uses bearer tokens to create sessions if successfully from handshake.
// This will allow the program to only have to ask for access the first time of the session.
// It then retrieves the device information based on a device service tag

  function getDellWarranty(serviceTag) {

  var cache = CacheService.getDocumentCache();
  var bearerToken = cache.get("dell_access_token");

  // If the bearer token has not been previously set, request a new one
  if(!bearerToken) {
  
    //auth and get our token thing
    var options = {
      'method' : 'post',
      'payload' : {
        'client_id': clientId,
        'client_secret': clientSecret,
        'grant_type': 'client_credentials'
      }
    };
    var authenticationResponseHttp = UrlFetchApp.fetch("https://apigtwb2c.us.dell.com/auth/oauth/v2/token", options);
    var authenticationResponse = JSON.parse(authenticationResponseHttp);
  
    //store the access token (bearer token) in the cache for the duration that it is valid - a bit
    cache.put("dell_access_token", authenticationResponse.access_token, authenticationResponse.expires_in / 2);
    bearerToken = authenticationResponse.access_token;
  }
  
  // to use bearer token to retrieve warranty through the production endpoint url.
  var getOptions = {
    'method': 'get',
    'headers' : {
      'Authorization': 'Bearer ' + bearerToken,
    }
  };

  // This should really be done as a bulk request but due to limited timeframe just doing as a request by request basis. - FIX THIS? - Might not as doing bulk still need to loop anyways. Not sure.
  var jsondata = UrlFetchApp.fetch("https://apigtwb2c.us.dell.com/PROD/sbil/eapi/v5/asset-entitlements?servicetags=" + serviceTag, getOptions);
  var apiResponse = JSON.parse(jsondata);
  var warranties = apiResponse[0].entitlements; // list
  
  var warranty = {
    productDescription:   apiResponse[0].productLineDescription,
    basicWarranty:        '1970-01-01T00:00:00',
    lobCategory:          apiResponse[0].productLobDescription, 
    shipDate:             apiResponse[0].shipDate,
    adpWarranty:          '1970-01-01T00:00:00',
    batteryWarranty:      '1970-01-01T00:00:00'
  };


  // Find warranty for basic, ADP, and Battery
  for(var index=0; index < warranties.length; ++index) 
  {
    //Basic
    if( warranties[index].endDate > warranty.basicWarranty && 
      (warranties[index].serviceLevelDescription.indexOf('ProSupport') > -1 || warranties[index].serviceLevelDescription.indexOf('Next Business') >-1))
    {
      warranty.basicWarranty = warranties[index].endDate;
      // console.log(warranties[index].serviceLevelDescription + warranty.basicWarranty);
    }

    // ADP
    if( warranties[index].endDate > warranty.adpWarranty && warranties[index].serviceLevelDescription.indexOf('Accident') > -1)
    {
      warranty.adpWarranty = warranties[index].endDate;
      // console.log(warranties[index].serviceLevelDescription + warranty.basicWarranty);
    }

    // Battery
    if( warranties[index].endDate > warranty.batteryWarranty && warranties[index].serviceLevelDescription.indexOf('Battery') > -1)
    {
      warranty.batteryWarranty = warranties[index].endDate;
      // console.log(warranties[index].serviceLevelDescription + warranty.batteryWarranty);
    }

  }

  // Check if warranty still equals default date. If so, that means there is not any warranty for it
  if(warranty.basicWarranty == '1970-01-01T00:00:00') warranty.basicWarranty = 'There is no warranty for this';
  if(warranty.adpWarranty == '1970-01-01T00:00:00') warranty.adpWarranty = 'There is no warranty for this';
  if(warranty.batteryWarranty == '1970-01-01T00:00:00') warranty.basicWarranty = 'There is no warranty for this';

  // create an array to store information needed for the spreadsheet and return it so it can be used elsewhere
  var returnArray = [];
  returnArray.push(
    [warranty.productDescription],
    [warranty.lobCategory],
    [warranty.shipDate],
    [warranty.basicWarranty.substring(0,10)],
    [warranty.adpWarranty.substring(0,10)],
    [warranty.batteryWarranty.substring(0,10)]
  );
  return returnArray;
}
